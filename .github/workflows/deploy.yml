name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch full history
          ref: main        # always sync with main branch

      - name: Sync project to target folder
        run: |
          rsync -av --delete ./ ~/Documents/Projects/Price_Scraper/

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync

      # - name: Install Playwright browsers (with cache)
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/.cache/ms-playwright
      #     key: playwright-${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
      #   id: playwright-cache

      # - name: Run playwright install
      #   run: uv run playwright install --with-deps

      # - name: Run price tracker
      #   run: uv run python main.py

      - name: Run script with secrets
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: uv run python main.py